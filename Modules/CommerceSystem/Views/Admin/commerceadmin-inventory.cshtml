
@using Newtonsoft.Json;

@inherits NantCom.NancyBlack.NancyBlackRazorViewBase
@{
    Layout = "_admin.cshtml";
}

@section Title
    {
    Administration - Inventory
}
@section Scripts
{
    <script src="/NancyBlack/Modules/CommerceSystem/Views/Admin/commerceadmin-inventory.js"></script>
    <script>

        window.commerceSettings = @this.Html.Raw(this.Site.commerce.ToString());

        window.data = {};
        window.data.ProductUrl = @this.GetJsonRaw(this.Database.Query("SELECT Id, Url FROM Product WHERE Instr(Url, '/archive/') = 0 AND  Instr(Url, '/promotions/') = 0", new { Id = 0, Url = "" }));
        window.data.AveragePrice = @this.GetJsonRaw(this.Database.Query("SELECT ProductId, AVG(BuyingPrice) as Price FROM InventoryPurchase GROUP BY ProductId", new { ProductId = 0, Price = 0.0 }));
        window.data.Instock = @this.GetJsonRaw(this.Database.Query("SELECT ProductId, SUM(BuyingPrice) as Price, SUM(1) as Qty FROM InventoryPurchase WHERE InventoryItemId = 0 GROUP BY ProductId", new { ProductId = 0, Price = 0M, Qty = 0 }));
        window.data.WaitingForInbound = @this.GetJsonRaw(this.Database.Query("SELECT ProductId, SUM(BuyingPrice) as Price, SUM(1) as Qty FROM InventoryPurchase WHERE InventoryItemId = 0 AND IsInBound = 0 GROUP BY ProductId", new { ProductId = 0, Price = 0M, Qty = 0 }));
        window.data.InventoryRequests = @this.GetJsonRaw(this.Database.Query("SELECT ProductId, SUM(1) as Qty, AVG(SellingPrice) as SoldPrice FROM InventoryItem WHERE IsFullFilled = 0 GROUP BY ProductId", new { ProductId = 0, Qty = 0, SoldPrice = 0M }));
        window.data.PendingSaleOrders = @this.GetJsonRaw(this.Database.Query("SELECT Id, Status FROM SaleOrder WHERE Status != 'Delivered' AND Status != 'Cancel' AND Status != 'New' AND Status != 'Confirmed'", new { Id = 0, Status = "" }));
        window.data.InventoryRequestRaw = @this.GetJsonRaw(this.Database.Query("SELECT Id, SaleOrderId, ProductId FROM InventoryItem WHERE IsFullFilled = 0", new { Id = 0, SaleOrderId = 0, ProductId = 0 }));

        window.productUrlLookup = [];
        window.data.ProductUrl.forEach(function (item) {
                       
            window.productUrlLookup[item.Id] = item.Url;
        });

    </script>
}
<div ng-module="InventoryAdminModule">
    <h1 class="page-header"
        style="padding-top: 25px">
        Inventory
        <i class="fa fa-spinner fa-circle-o-notch" ng-show="isBusy"></i>

        <a class="btn btn-warning pull-right"
           href="/Admin/tables/inventoryitem/__recheck"
           target="_blank">
            Force Recheck
        </a>
    </h1>

    <div>
        <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">
            {{alert.msg}}
        </alert>
    </div>

    <tabset>
        <tab heading="Inventory Dashboard">

            <div class="row">


                <div class="col-md-6">

                    <div ng-controller="InventoryNotFullfilled2 as ctrl">

                        <h3 class="page-header text-danger">
                            Required

                            <span class="pull-right">
                                <b>{{totalValue | number:2}}</b>
                            </span>
                        </h3>

                        <table class="table table-striped table-hover table-responsive">

                            <tbody>
                                <tr>
                                    <th width="80%">Item</th>
                                    <th>Need (Total)</th>
                                    <th>Need (Incoming)</th>
                                    <th>Stock</th>
                                    <th>Diff</th>
                                </tr>
                                <tr ng-repeat="item in data | orderBy:'Url' "
                                    ng-class="{'danger' : item.QtyStock - item.Qty < 0 }">
                                    <td>
                                        <span ncb-vlookup="product" key="{{item.ProductId}}" label="Title"></span>
                                        <br />
                                        <div ng-if="item.SaleOrderWaiting.length > 0">

                                            <b>Waiting For Order:</b><br />
                                            <a ng-repeat="so in item.SaleOrderWaiting track by $index" target="_blank"
                                               href="/Admin/tables/saleorder/{{so}}">
                                                {{so}}
                                            </a>
                                        </div>

                                        <div ng-if="item.SaleOrderIncoming.length > 0">
                                            <b>Incoming:</b>
                                            <a ng-repeat="so in item.SaleOrderIncoming track by $index" target="_blank"
                                               href="/Admin/tables/saleorder/{{so}}">
                                                {{so}}
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        {{item.Qty}}
                                    </td>
                                    <td>
                                        {{item.SaleOrderIncoming.length}}
                                    </td>
                                    <td>
                                        {{item.QtyStock}}
                                    </td>
                                    <td>
                                        <b>
                                            {{item.QtyStock - item.Qty}}
                                        </b>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                </div>
                
                <div class="col-md-6">

                    <div ng-controller="InventoryInstock as ctrl">

                        <h3 class="page-header text-success">
                            Stock

                            <span class="pull-right">
                                <b>{{totalValue | number:2}}</b>
                            </span>
                        </h3>

                        <table class="table table-striped table-hover table-responsive">

                            <tbody>
                                <tr>
                                    <th width="80%">Item</th>
                                    <th>Total</th>
                                    <th>Waiting</th>
                                    <th>Now</th>
                                </tr>
                                <tr ng-repeat="item in data | orderBy:'Url'">
                                    <td>
                                        <span ncb-vlookup="product" key="{{item.ProductId}}" label="Title"></span>
                                    </td>
                                    <td>
                                        {{item.Qty}}
                                    </td>
                                    <td>
                                        {{item.QtyWaiting}}
                                    </td>
                                    <td>
                                        <b>{{item.Qty - item.QtyWaiting}}</b>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <div class="panel panel-primary"
                         ng-controller="InventoryInboundController2 as ctrl">
                        <div class="panel-heading">Inventory Inbound</div>
                        <div class="panel-body">

                            <select ng-model="inbound.invoice"
                                    ncb-select title="Invoice Number">
                                <option ng-repeat="invoice in invoicenumbers">{{invoice.SupplierInvoiceNumber}}</option>
                            </select>

                            <input ncb-textbox type="text" title="Scan Barcode" ng-model="inbound.barcode"
                                   ng-disabled="inbound.invoice == null"
                                   ng-blur="ctrl.submit()" />

                            <ncb-alerts alerts="status">
                            </ncb-alerts>
                        </div>
                    </div>


                </div>

            </div>

        </tab>


    </tabset>

</div>