
@using Newtonsoft.Json;

@inherits NantCom.NancyBlack.NancyBlackRazorViewBase
@{
    Layout = "_admin.cshtml";
}

@section Title
    {
    Administration - Inventory
}
@section Scripts
{
    <script src="/NancyBlack/Modules/CommerceSystem/Views/Admin/commerceadmin-inventory.js"></script>
    <script>

        window.commerceSettings = @this.Html.Raw(this.Site.commerce.ToString());
    </script>
}
<div ng-module="InventoryAdminModule">
    <h1 class="page-header">
        Inventory
        <i class="fa fa-spinner fa-circle-o-notch" ng-show="isBusy"></i>
    </h1>

    <div>
        <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">
            {{alert.msg}}
        </alert>
    </div>

    <tabset>
        <tab heading="Inventory Dashboard">

            <div class="row">

                <div ng-controller="InventoryNotFullfilled as ctrl"
                     class="col-md-6">

                    <h3 class="page-header text-primary">
                        Waiting for Order

                        <span class="pull-right">
                            <b class="text-danger">
                                {{totalBuying | number:2}}
                            </b> /
                            <span class="text-info">
                                {{totalSelling | number:2}}
                            </span>
                        </span>
                    </h3>

                    <div ng-repeat="(key, value) in data | groupBy:'SupplierId' | orderBy:'$key'">

                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <span ncb-vlookup="supplier" key="{{key}}" label="Name"></span>
                            </div>
                            <div class="panel-body">
                                <table class="table table-striped table-hover table-responsive">

                                    <tbody>
                                        <tr>
                                            <th width="60%">Item</th>
                                            <th width="20%">Avg Price.</th>
                                            <th>Qty</th>
                                        </tr>
                                        <tr ng-repeat="(key, value) in value | groupBy:'ProductId'">
                                            <td>
                                                <span ncb-vlookup="product" key="{{key}}" label="Title"></span>
                                            </td>
                                            <td>
                                                {{averagePrices[key] | number:2}}
                                            </td>
                                            <td>
                                                {{value.length}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <div ng-controller="InventoryNotInbound as ctrl"
                     class="col-md-6">

                    <h3 class="page-header text-warning">
                        Waiting for Inbound

                        <span class="pull-right">
                            <b class="text-danger">
                                {{totalBuying | number:2}}
                            </b>
                        </span>
                    </h3>
                    <div ng-repeat="(key, value) in data | groupBy:'SupplierId' | orderBy:'$key'">

                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <span ncb-vlookup="supplier" key="{{key}}" label="Name"></span>
                            </div>
                            <div class="panel-body">
                                <table class="table table-striped table-hover table-responsive">

                                    <tbody>
                                        <tr>
                                            <th width="80%">Item</th>
                                            <th>Qty</th>
                                        </tr>
                                        <tr ng-repeat="(key, value) in value | groupBy:'ProductId'">
                                            <td>
                                                <span ncb-vlookup="product" key="{{key}}" label="Title"></span>
                                            </td>
                                            <td>
                                                {{value.length}}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>


            </div>

        </tab>

        <tab heading="Inventory List">

            <div>

                <div ng-controller="InventoryInstock as ctrl">

                    <h3 class="page-header text-success">
                        In Stock

                        <span class="pull-right">
                            <b>{{totalValue | number:2}}</b>
                        </span>
                    </h3>
                    
                    <table class="table table-striped table-hover table-responsive">

                        <tbody>
                            <tr>
                                <th width="80%">Item</th>
                                <th>Qty</th>
                            </tr>
                            <tr ng-repeat="item in data">
                                <td>
                                    <span ncb-vlookup="product" key="{{item.ProductId}}" label="Title"></span>
                                </td>
                                <td>
                                    {{item.Qty}}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                </div>




            </div>

            <div ncb-datacontext table="InventoryItem">

                <ncb-ngtable tabletemplate="'tablecustomtemplate.html'" modalid="InventoryItemModal">
                </ncb-ngtable>
            </div>

        </tab>

    </tabset>

    <script type="text/ng-template" id="tablecustomtemplate.html">

        <table id="NcbNgTable"
               ncb-datatable
               class="table table-striped table-hover"
               style="width: 100%"
               ng-table="tableParams"
               show-filter="true">

            <tr ng-repeat="item in tableParams.data">

                <td data-title="'Last Update'"
                    sortable="'__updatedAt'">
                    {{item.__updatedAt | date:'dd MMMM yyyy, HH:mm' }}
                </td>
                <td data-title="'FullFilled'"
                    sortable="'IsFullfilled'"
                    filter="{ 'IsFullfilled': 'text' }">
                    {{item.IsFullfilled }}<br/>
                    <a ng-if="item.SaleOrderId > 0" target="_blank"
                       href="{{'/Admin/tables/saleorder/' + item.SaleOrderId}}">SO - {{item.SaleOrderId}}</a>
                </td>
                <td data-title="'RequestedDate'"
                    sortable="'RequestedDate'">
                    {{item.RequestedDate | date:'dd MMMM yyyy, HH:mm' }}
                </td>
                <td data-title="'InboundDate'"
                    sortable="'InboundDate'">
                    {{item.InboundDate | date:'dd MMMM yyyy, HH:mm' }}
                </td>
                <td data-title="'OutboundDate'"
                    sortable="'OutboundDate'">
                    {{item.OutboundDate | date:'dd MMMM yyyy, HH:mm' }}
                </td>
                <td data-title="'Product'"
                    sortable="'ProductId'"
                    filter="{ 'ProductId': 'text' }">
                    <span ncb-vlookup="Product" key="{{item.ProductId}}">
                    </span>
                </td>
                <td data-title="'Note'"
                    sortable="'Note'"
                    filter="{ 'Note': 'text' }">
                    {{item.Note }}
                </td>
                <td data-title="'Buy'"
                    sortable="'BuyingCost'"
                    filter="{ 'BuyingCost': 'text' }">
                    <b>{{item.BuyingCost | number:2 }}</b><br />
                    <span class="text-subtle">{{item.BuyingTax | number:2 }}</span>
                </td>
                <td data-title="'Sell'"
                    sortable="'SellingPrice'"
                    filter="{ 'SellingPrice': 'text' }">
                    <b>{{item.SellingPrice | number:2 }}</b><br />
                    <span class="text-subtle">{{item.SellingTax | number:2 }}</span>
                </td>
            </tr>
        </table>

    </script>

</div>